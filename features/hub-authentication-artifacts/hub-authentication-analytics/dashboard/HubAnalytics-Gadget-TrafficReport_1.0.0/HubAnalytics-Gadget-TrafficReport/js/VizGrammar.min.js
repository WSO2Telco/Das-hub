function getPieMark(e,t){var a;if("donut"==e.mode)var a=e.height/5*(1+e.innerRadius);else if("pie"==e.mode)var a=0;else{e.innerRadius+=.5;var a=e.height/5*(1+e.innerRadius)}var i=e.title,l="";null!=e.type&&(i="layout",l="a.");var r={type:"arc",from:{data:i},properties:{update:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},startAngle:{field:"layout_start"},endAngle:{field:"layout_end"},innerRadius:{value:a},outerRadius:{value:.4*e.height},fill:{scale:"color",field:l+t.names[e.color]},fillOpacity:{value:1}},hover:{fillOpacity:{value:.8},cursor:{value:e.hoverCursor}}}};return r}function getPieMidText(e,t){var a={type:"text",from:{data:"layout"},properties:{update:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},radius:{value:0},theta:{field:"layout_mid"},fill:[{test:"indata('arc', datum.a."+t.names[e.color]+", 'type')",scale:"color",field:t.names[e.color]},{}],align:{value:"center"},baseline:{value:"middle"},fontSize:{value:e.height/9},text:{template:"{{datum.percentage | number:'.2f'}}%"}}}};return a}function getPieText(e,t){var a={type:"text",from:{data:"layout"},properties:{update:{x:{field:{group:"width"},mult:.5},y:{field:{group:"height"},mult:.5},radius:{value:.5*e.height},theta:{field:"layout_mid"},fill:{value:"#000"},align:{value:"center"},baseline:{value:"middle"},text:{template:"{{datum.percentage | number:'.2f'}}%"}}}};return a}function getAreaMark(e,t){var a;return a=-1!=e.color&&"stack"==e.mode?{type:"group",from:{data:e.title,transform:[{type:"stack",groupby:[t.names[e.x]],sortby:[t.names[e.color]],field:t.names[e.y]},{type:"facet",groupby:[t.names[e.color]]}]},marks:[{type:"area",properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:t.names[e.color]},strokeWidth:{value:2},fillOpacity:{value:e.fillOpacity}},hover:{strokeOpacity:{value:.5}}}}]}:-1!=e.color?{type:"group",from:{data:e.title,transform:[{type:"facet",groupby:[t.names[e.color]]}]},marks:[{type:"area",properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},fill:{scale:"color",field:t.names[e.color]},strokeWidth:{value:2},fillOpacity:{value:e.fillOpacity}},hover:{strokeOpacity:{value:.5}}}}]}:{type:"area",from:{data:e.title},properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},fill:{value:e.markColor},strokeWidth:{value:2},fillOpacity:{value:e.fillOpacity}},hover:{fillOpacity:{value:.5}}}}}function getBarMark(e,t){var a;a="left"==e.orientation?{y:{scale:"x",field:t.names[e.x]},height:{scale:"x",band:!0,offset:calculateBarGap(e)},x:{scale:"y",field:t.names[e.y]},x2:{scale:"y",value:0},fill:{value:e.markColor},fillOpacity:{value:e.fillOpacity}}:{x:{scale:"x",field:t.names[e.x]},width:{scale:"x",band:!0,offset:calculateBarGap(e)},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},fill:{value:e.markColor},fillOpacity:{value:e.fillOpacity}};var i={name:"bars",type:"rect",from:{data:e.title},properties:{update:a,hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}};return i}function getStackBarMark(e,t){return"left"==e.orientation?mark={name:"bars",type:"rect",from:{data:e.title,transform:[{type:"stack",groupby:[t.names[e.x]],sortby:[t.names[e.color]],field:t.names[e.y]}]},properties:{update:{y:{scale:"x",field:t.names[e.x]},height:{scale:"x",band:!0,offset:calculateBarGap(e)},x:{scale:"y",field:"layout_start"},x2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:t.names[e.color]},fillOpacity:{value:e.fillOpacity}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}}:mark={name:"bars",type:"rect",from:{data:e.title,transform:[{type:"stack",groupby:[t.names[e.x]],sortby:[t.names[e.color]],field:t.names[e.y]}]},properties:{update:{x:{scale:"x",field:t.names[e.x]},width:{scale:"x",band:!0,offset:calculateBarGap(e)},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:t.names[e.color]},fillOpacity:{value:e.fillOpacity}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}},mark}function getGroupBarMark(e,t){var a;return a="left"==e.orientation?{name:"bars",type:"group",from:{data:e.title,transform:[{type:"facet",groupby:[t.names[e.x]]}]},properties:{update:{y:{scale:"x",field:"key"},height:{scale:"x",band:!0}}},scales:[{name:"pos",type:"ordinal",range:"height",domain:{field:t.names[e.color]}}],marks:[{name:"bar",type:"rect",properties:{update:{y:{scale:"pos",field:t.names[e.color]},height:{scale:"pos",band:!0,offset:calculateBarGap(e)},x:{scale:"y",field:t.names[e.y]},x2:{scale:"y",value:0},fill:{scale:"color",field:t.names[e.color]},fillOpacity:{value:e.fillOpacity}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}}]}:{name:"bars",type:"group",from:{data:e.title,transform:[{type:"facet",groupby:[t.names[e.x]]}]},properties:{update:{x:{scale:"x",field:"key"},width:{scale:"x",band:!0}}},scales:[{name:"pos",type:"ordinal",range:"width",domain:{field:t.names[e.color]}}],marks:[{name:"bar",type:"rect",properties:{update:{x:{scale:"pos",field:t.names[e.color]},width:{scale:"pos",band:!0,offset:calculateBarGap(e)},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},fill:{scale:"color",field:t.names[e.color]},fillOpacity:{value:e.fillOpacity}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}}]}}function calculateBarGap(e){var t,a=30;return t="left"==e.orientation?e.height:e.width,"group"==e.mode&&(a=80),-e.barGap*(t/a)}function getLineMark(e,t){var a;return a=-1!=e.color&&"stack"==e.mode?{type:"group",from:{data:e.title,transform:[{type:"stack",groupby:[t.names[e.x]],sortby:[t.names[e.color]],field:t.names[e.y]},{type:"facet",groupby:[t.names[e.color]]}]},marks:[{type:"line",properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},stroke:{scale:"color",field:t.names[e.color]},strokeWidth:{value:2}},hover:{strokeOpacity:{value:.5}}}}]}:-1!=e.color?{type:"group",from:{data:e.title,transform:[{type:"facet",groupby:[t.names[e.color]]}]},marks:[{type:"line",properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},stroke:{scale:"color",field:t.names[e.color]},strokeWidth:{value:2}},hover:{strokeOpacity:{value:.5}}}}]}:{type:"line",from:{data:e.title},properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},y2:{scale:"y",value:0},stroke:{value:e.markColor},strokeWidth:{value:2}},hover:{fillOpacity:{value:.5}}}}}function getTopoJson(e,t){var a,i=e.width,l=e.height,r=e.charts[0].mapType,o="mercator";"usa"==r?(i=e.width-160,l=e.height-130,a=e.height+270,o="albersUsa"):"europe"==r?(i=(e.width/2+100)/2,l=e.height+150,a=e.height+50):(a=e.width/640*120,i=e.width/2+10,l=e.height/2+40);var s=e.geoCodesUrl,n={name:"geoData",url:s,format:{type:"topojson",feature:"units"},transform:[{type:"geopath",value:"data",scale:a,translate:[i,l],projection:o},{type:"lookup",keys:["id"],on:e.title,onKey:t.names[e.x],as:["zipped"],"default":{v:null,country:"No data"}}]};return n}function getMapMark(e,t){var a=[{name:"map",type:"path",from:{data:"geoData"},properties:{enter:{path:{field:"layout_path"}},update:{fillOpacity:{value:1},fill:{rule:[{predicate:{name:"isNotNull",id:{field:"zipped.v"}},scale:"color",field:"zipped.v"},{value:e.mapColor}]}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}},{type:"group",from:{data:e.title,transform:[{type:"filter",test:"datum."+t.names[e.x]+" == tooltipSignal.datum."+t.names[e.x]}]},properties:{update:{x:{signal:"tooltipSignal.x",offset:-5},y:{signal:"tooltipSignal.y",offset:20},width:{value:100},height:{value:20},fill:{value:e.tooltip.color}}},marks:[{type:"text",properties:{update:{x:{value:6},y:{value:14},text:{template:"{{tooltipSignal.datum.unitName}} {{tooltipSignal.datum.v}}"},fill:{value:"black"}}}}]}];return a}function getMapSignals(){var e=[{name:"tooltipSignal",init:{expr:"{x: 0, y: 0, datum: {} }"},streams:[{type:"@map:mouseover",expr:"{x: eventX(), y: eventY(), datum: eventItem().datum.zipped}"},{type:"@map:mouseout",expr:"{x: 0, y: 0, datum: {} }"}]}];return e}function getMapPredicates(){var e={name:"isNotNull",type:"!=",operands:[{value:null},{arg:"id"}]};return e}function getMapLegends(e,t){var a={fill:"color",title:t.names[e.y],properties:{gradient:{stroke:{value:"transparent"}},title:{fontSize:{value:14}},legend:{x:{value:0},y:{value:e.height-40}}}};return a}function loadGeoMapCodes(e){var t,a=new XMLHttpRequest;return a.overrideMimeType("application/json"),a.open("GET",e,!1),a.onreadystatechange=function(){4==a.readyState&&"200"==a.status&&(t=JSON.parse(a.responseText))},a.send(null),t}function getMapCode(e,t,a){if("world"==t||"europe"==t)for(i=0;i<a.length;i++)e.toUpperCase()==a[i].name.toUpperCase()&&(e=a[i]["alpha-3"]);else{var i=0;for(var l in a)a.hasOwnProperty(l)&&e.toUpperCase()==l.toUpperCase()&&(e="US"+a[l]),i++}return e}function getScatterMark(e,t){var a,i;a=-1==e.color?{value:e.markColor}:{scale:"color",field:t.names[e.color]},i=-1==e.size?{value:50*e.markSize}:{scale:"size",field:t.names[e.size]};var l={type:"symbol",from:{data:e.title},properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},fill:a,size:i,fillOpacity:{value:1}},hover:{fillOpacity:{value:.5},cursor:{value:e.hoverCursor}}}};return l}function getScatterToolTipMark(e,t){e.toolTip.height=50,e.toolTip.y=-50;var a=getToolTipMark(e,t),i={type:"text",properties:{update:{x:{value:6},y:{value:44},text:{template:"Size 	 ("+t.names[e.size]+") 	 {{hover."+t.names[e.size]+"}}"},fill:{value:"black"}}}};return a.marks.push(i),a}function checkConfig(e,t){null==e.color?e.color=-1:"*"!=e.color&&(e.color=t.names.indexOf(e.color)),null==e.size?e.size=-1:e.size=t.names.indexOf(e.size);var a={title:"table",mapType:-1,mode:"group",colorScale:"category10",colorDomain:-1,maxLength:-1,markSize:2,fillOpacity:1,innerRadius:0,renderer:"svg",padding:{top:10,left:50,bottom:40,right:0},dateFormat:"%x %X",range:!1,rangeColor:"#222",selectionColor:"#222",selectionOpacity:.6,barGap:1,mapColor:"#888",hoverCursor:"pointer",rangeCursor:"grab",textColor:"#888",tooltip:{enabled:!0,bgColor:"#000",textColor:"#fff",opacity:"0.9",fontSize:"12px",type:"symbol"},legend:!0,legendTitle:"Legend",legendTitleColor:"#222",legendTitleFontSize:13,legendTextColor:"#888",ledgendTextFontSize:12,xTitle:e.x,yTitle:e.y,xAxisAngle:!1,yAxisAngle:!1,xAxisStrokeSize:0,xAxisColor:"#222",xAxisSize:1,xAxisFontSize:10,xAxisTitleFontSize:12,xAxisTitleFontColor:"#222",yAxisStrokeSize:0,yAxisColor:"#222",yAxisSize:1,yAxisFontSize:10,yAxisTitleFontSize:12,yAxisTitleFontColor:"#222",grid:!0,zero:!1,xTicks:10,yTicks:10,xFormat:"",yFormat:"",xScaleDomain:null,yScaleDomain:null};return"undefined"!=typeof vizgSettings&&(a=extend(a,vizgSettings)),e=extend(a,e),e.legend&&(e.padding.right=60),e.height=e.height-(e.padding.top+e.padding.bottom),e.width=e.width-(e.padding.left+e.padding.right),"string"==typeof e.colorScale?e.markColor=window.d3.scale[e.colorScale]().range()[0]:e.markColor=e.colorScale[0],e.x=t.names.indexOf(e.x),e.y=t.names.indexOf(e.y),e.text=t.names.indexOf(e.text),null==e.xScaleDomain&&(e.xScaleDomain={data:e.title,field:t.names[e.x]}),null==e.yScaleDomain&&(e.yScaleDomain={data:e.title,field:t.names[e.y]}),e}function buildTable(e){var t={};return t.metadata=e[0].metadata,t.values=buildData(e[0].data,e[0].metadata),t}function buildData(e,t){for(chartData=[],i=0;i<e.length;i++){var a={};for(x=0;x<t.names.length;x++)a[t.names[x]]=e[i][x];chartData.push(a)}return chartData}function getSymbolMark(e,t){var a;a=-1!=e.color?{scale:"color",field:t.names[e.color]}:{value:e.markColor};var i;return i="stack"==e.mode?{type:"group",from:{data:e.title,transform:[{type:"stack",groupby:[t.names[e.x]],sortby:[t.names[e.color]],field:t.names[e.y]},{type:"facet",groupby:[t.names[e.color]]}]},marks:[{type:"symbol",properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:"layout_start"},y2:{scale:"y",field:"layout_end"},fill:{scale:"color",field:t.names[e.color]},size:{value:e.markSize},fillOpacity:{value:e.fillOpacity}},hover:{cursor:{value:e.hoverCursor}}}}]}:{name:"points-group",type:"symbol",from:{data:e.title},properties:{update:{x:{scale:"x",field:t.names[e.x]},y:{scale:"y",field:t.names[e.y]},fill:a,size:{value:e.markSize},fillOpacity:{value:e.fillOpacity}},hover:{cursor:{value:e.hoverCursor}}}}}function getSignals(e,t){var a=[{name:"hover",init:{},streams:[{type:e.hoverType+":mouseover",expr:"datum"},{type:e.hoverType+":mouseout",expr:"{}"}]}];return a}function bindTooltip(e,t,a,i,l,r){a.on("mouseover",function(a,o){if(null!=o&&"exit"!=o.status&&o.mark.marktype==t){var s=$(".marks")[0];$("#wrapper #tip").length&&$tip.remove(),$(e).wrap("<div id='wrapper' style='position: relative'></div>"),$("#wrapper").append("<div id='tip' class='chart-tooltip' style='top:0; left: 0; position: absolute'></div>"),$tip=$("#tip"),$tip.empty();var n=o.datum,c="";for(var p in n)if(n.hasOwnProperty(p))if(void 0!=r){for(var d=0;d<r.length;d++)for(var h in i)if(h==r[d]&&l.names[i[h]]==p){c+="<p>"+r[d]+" ("+p+"):"+n[p]+"</p>";break}}else l.names[i.x]==p&&(c+="<p>X ("+p+"):"+n[p]+"</p>"),l.names[i.y]==p&&(c+="<p>Y ("+p+"):"+n[p]+"</p>");$tip.append(c);var u=s.width,f=s.height,m=$('.marks[style*="width"]');m.length>0&&(u=parseFloat($(".marks")[0].style.width),f=parseFloat($(".marks")[0].style.height));var g,y=$tip.width(),v=$tip.height(),x=o.bounds.x2+i.padding.left+y,b=f-o.bounds.y2-i.padding.top+v,k=o.bounds.y2+i.padding.top-v;g=x>u?o.bounds.x2+i.padding.left-y:o.bounds.x2+i.padding.left,b>f&&(k=o.bounds.y2+i.padding.top),$tip.css({left:g,top:k}).show()}else $("#wrapper #tip").length&&$tip.remove(),$(e).closest("#wrapper").length&&$(e).unwrap()})}function createTooltip(e){document.getElementById(e.replace("#","")).innerHTML=document.getElementById(e.replace("#","")).innerHTML+"<div id= "+e.replace("#","")+"-tooltip class='chart-tooltip'></div>"}function bindTooltip(e,t,a,i){t.on("mouseover",function(t,l){if(null!=l&&l.mark.marktype==a.tooltip.type){var r=l.datum;null!=l.datum&&null!=l.datum.a&&(r=l.datum.a);var o=document.getElementById(e.replace("#","")+"-tooltip"),s="";if(null!=r[i.names[a.x]]){var n;if(null==a.tooltip.content){if("time"==i.types[a.x]){var c=d3.time.format(a.dateFormat);n=c(new Date(parseInt(r[i.names[a.x]])))}else n=r[i.names[a.x]];s+="<b>Total Count</b> : "+n+"<br/>",null!=r[i.names[a.y]]&&(s+="<b>"+i.names[a.y]+"</b> : "+r[i.names[a.y]]+"<br/>")}else for(var p=0;p<a.tooltip.content.length;p++){if("time"===i.types[i.names.indexOf(a.tooltip.content[p])]){var c=d3.time.format(a.dateFormat);n=c(new Date(parseInt(r[i.names[a.x]])))}else n=r[a.tooltip.content[p]];s+=0!=a.tooltip.label?"<b>"+a.tooltip.content[p]+"</b> : "+n+"<br/>":n+"<br/>"}}""!=s&&(o.innerHTML=s,o.style.padding="5px",o.style.backgroundColor=a.tooltip.bgColor,o.style.color=a.tooltip.textColor,o.style.fontSize=a.tooltip.fontSize,o.style.opacity=a.tooltip.opacity,o.style.opacity=a.tooltip.opacity,o.className="chart-tooltip"),window.onmousemove=function(t){o.style.top=t.clientY+15+"px",o.style.left=t.clientX+10+"px",o.style.zIndex=1e3,o.style.backgroundColor=a.tooltip.color,o.style.position="fixed",o.offsetWidth+t.clientX-(cumulativeOffset(document.getElementById(e.replace("#",""))).left+a.padding.left)>document.getElementById(e.replace("#","")).offsetWidth&&(o.style.left=t.clientX-o.offsetWidth+"px"),t.clientY-(cumulativeOffset(document.getElementById(e.replace("#",""))).top+500)>document.getElementById(e.replace("#","")).offsetHeight&&(o.style.top=t.clientY-400+"px")}}}).on("mouseout",function(t,a){var i=document.getElementById(e.replace("#","")+"-tooltip");i.style.padding="0px 0px 0px 0px",i.innerHTML=""}).update()}function cumulativeOffset(e){var t=0,a=0;do t+=e.offsetTop||0,a+=e.offsetLeft||0,e=e.offsetParent;while(e);return{top:t,left:a}}function getXYAxes(e,t,a,i,l){var r={ticks:{stroke:{value:e.xAxisColor},strokeWidth:{value:e.xAxisStrokeSize}},labels:{fill:{value:e.xAxisColor},fontSize:{value:e.xAxisFontSize}},title:{fontSize:{value:e.xAxisTitleFontSize},fill:{value:e.xAxisTitleFontColor}},axis:{stroke:{value:e.xAxisColor},strokeWidth:{value:e.xAxisSize}}},o={ticks:{stroke:{value:e.yAxisColor},strokeWidth:{value:e.yAxisStrokeSize}},labels:{fill:{value:e.yAxisColor},fontSize:{value:e.yAxisFontSize}},title:{fontSize:{value:e.yAxisTitleFontSize},fill:{value:e.yAxisTitleFontColor}},axis:{stroke:{value:e.yAxisColor},strokeWidth:{value:e.yAxisSize}}};e.xAxisAngle&&(r.labels.angle={value:45},r.labels.align={value:"left"},r.labels.baseline={value:"middle"}),e.yAxisAngle&&(o.labels.angle={value:45},o.labels.align={value:"left"},o.labels.baseline={value:"middle"});var s=[{type:t,scale:a,grid:e.grid,format:e.xFormat,ticks:e.xTicks,title:e.xTitle,properties:r},{type:i,scale:l,grid:e.grid,format:e.yFormat,ticks:e.yTicks,title:e.yTitle,properties:o}];return s}function getXYScales(e,t){var a={name:"x",type:t.types[e.x],range:"width",zero:e.zero,domain:e.xScaleDomain},i={name:"y",type:t.types[e.y],range:"height",zero:e.zero,domain:e.yScaleDomain};return"bar"!=e.type&&(a.padding=1,i.padding=1),[a,i]}function getRangeSignals(e,t){return t.push({name:"range_start",streams:[{type:"mousedown",expr:"eventX()",scale:{name:"x",invert:!0}}]}),t.push({name:"range_end",streams:[{type:"mousedown, [mousedown, window:mouseup] > window:mousemove",expr:"clamp(eventX(), 0, "+e.width+")",scale:{name:"x",invert:!0}}]}),t}function getRangeMark(e,t){return t.push({type:"rect",properties:{enter:{y:{value:0},height:{value:e.height},fill:{value:e.rangeColor},fillOpacity:{value:.3}},update:{x:{scale:"x",signal:"range_start"},x2:{scale:"x",signal:"range_end"}}}}),t}function getLegend(e){var t=[{name:"legend",fill:"color",title:e.legendTitle,offset:0,properties:{symbols:{stroke:{value:"transparent"}},title:{fill:{value:e.legendTitleColor},fontSize:{value:e.legendTitleFontSize}},labels:{fill:{value:e.legendTextColor},fontSize:{value:e.ledgendTextFontSize}}}}];return t}function drawChart(e,t,a){var i=function(i){if(t.config.tooltip.enabled?(createTooltip(e),t.view=i({el:e}).renderer(t.config.renderer).update(),bindTooltip(e,t.view,t.config,t.metadata)):t.view=i({el:e}).renderer(t.config.renderer).update(),null!=a)for(var l=0;l<a.length;l++)if("range"==a[l].type){var r,o,s=a[l].callback;t.config.range&&(document.getElementById(e.replace("#","")).style.cursor="grab",t.view.onSignal("range_start",function(e,t){r=t}),t.view.onSignal("range_end",function(e,t){o=t,s(r,o)}))}else t.view.on(a[l].type,a[l].callback)}.bind(t);vg.parse.spec(t.spec,i)}var arc=function(e,t){this.metadata=e[0].metadata;var a=[];this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title;var i={};i[this.metadata.names[t.x]]="sum",e.push({name:"summary",source:t.title,transform:[{type:"aggregate",summarize:i}]}),e.push({name:"layout",source:"table",transform:[{type:"cross","with":"summary"},{type:"pie",field:"a."+this.metadata.names[t.x]},{type:"formula",field:"percentage",expr:"datum.a."+this.metadata.names[t.x]+" / datum.b.sum_"+this.metadata.names[t.x]+" * 100"}]});var l=[];-1==t.colorDomain&&(t.colorDomain={data:t.title,field:this.metadata.names[t.color]});var r={name:"color",type:"ordinal",domain:t.colorDomain,range:t.colorScale};l.push(r),!t.percentage||"pie"!=t.mode&&"donut"!=t.mode?t.percentage&&(e.push({name:"arc",values:[{type:"YES"}]}),a.push(getPieMidText(t,this.metadata))):a.push(getPieText(t,this.metadata)),a.push(getPieMark(t,this.metadata));var o="Legend";"table"!=t.title&&(o=t.title),this.config.legend&&(this.spec.legends=getLegend(this.config)),this.spec.width=t.width,this.spec.height=t.height,this.spec.data=e,this.spec.scales=l,this.spec.padding=t.padding,this.spec.marks=a};arc.prototype.draw=function(e,t){var a=function(a){if(this.config.tooltip.enabled?(this.config.tooltip.type="arc",createTooltip(e),this.view=a({el:e}).renderer(this.config.renderer).update(),bindTooltip(e,this.view,this.config,this.metadata)):this.view=a({el:e}).renderer(this.config.renderer).update(),null!=t)for(var i=0;i<t.length;i++)this.view.on(t[i].type,t[i].callback)}.bind(this);if(-1!=this.config.maxLength){var i=this.spec.data[0].values,l=this.config.maxLength;if(i.length>=this.config.maxLength){for(var r=[],o=i.length-l,s=o;s<i.length;s++)r.push(i[s]);this.spec.data[0].values=r}}vg.parse.spec(this.spec,a)},arc.prototype.insert=function(e){var t=this.metadata.names[this.config.color],a=this.metadata.names[this.config.x],l=this.view,r=!1;for(i=0;i<e.length;i++)this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},a,function(t){return r=!0,e[i][a]});0==r&&l.data(this.config.title).insert(e),this.view.update({duration:500})},arc.prototype.getSpec=function(){return this.spec};var area=function(e,t){this.metadata=e[0].metadata;var a=[],i=[];this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title;var l=getXYScales(t,this.metadata);if("stack"==t.mode){var r={name:"stack",source:t.title,transform:[{type:"aggregate",groupby:[this.metadata.names[t.x]],summarize:[{field:this.metadata.names[t.y],ops:["sum"]}]}]};e.push(r),yColumn="sum_"+this.metadata.names[t.y],yDomain="stack",l[1].domain={data:yDomain,field:yColumn}}if(delete l[1].zero,-1!=t.color){-1==t.colorDomain&&(t.colorDomain={data:t.title,field:this.metadata.names[t.color]});var o={name:"color",type:"ordinal",domain:t.colorDomain,range:t.colorScale};l.push(o);var s="Legend";"table"!=t.title&&(s=t.title),this.config.legend&&(this.spec.legends=getLegend(this.config))}var n=getXYAxes(t,"x","x","y","y");a.push(getLineMark(t,this.metadata)),t.fillOpacity=.7,a.push(getAreaMark(t,this.metadata)),t.fillOpacity=0,t.markSize=1e3,a.push(getSymbolMark(t,this.metadata)),t.fillOpacity=1,t.markSize=15,a.push(getSymbolMark(t,this.metadata)),t.range&&(i=getRangeSignals(t,i),a=getRangeMark(t,a)),this.spec.width=t.width,this.spec.height=t.height,this.spec.axes=n,this.spec.data=e,this.spec.scales=l,this.spec.padding=t.padding,this.spec.marks=a,this.spec.signals=i};area.prototype.draw=function(e,t){if(-1!=this.config.maxLength){var a=this.spec.data[0].values,i=this.config.maxLength;if(a.length>=this.config.maxLength){for(var l=[],r=a.length-i,o=r;o<a.length;o++)l.push(a[o]);this.spec.data[0].values=l}}drawChart(e,this,t)},area.prototype.insert=function(e){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+e.length){var t=function(e){return e[this.metadata.names[this.config.x]]==a}.bind(this);for(i=0;i<e.length;i++){var a=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(t)}}this.view.data(this.config.title).insert(e),this.view.update()},area.prototype.getSpec=function(){return this.spec};var bar=function(e,t){this.metadata=e[0].metadata;var a=[],i=[];this.spec={};var l,r,o,s,n,c,p=[];if(t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title,"left"==t.orientation?(o="height",s="width",n="y",c="x"):(o="width",s="height",n="x",c="y"),-1!=t.color){var d="Legend";"table"!=t.title&&(d=t.title),-1==t.colorDomain&&(t.colorDomain={data:t.title,field:this.metadata.names[t.color]});var h={name:"color",type:"ordinal",domain:t.colorDomain,range:t.colorScale};if(i.push(h),"stack"==t.mode){var u={name:"stack",source:t.title,transform:[{type:"aggregate",groupby:[this.metadata.names[t.x]],summarize:[{field:this.metadata.names[t.y],ops:["sum"]}]}]};e.push(u),l="sum_"+this.metadata.names[t.y],r="stack"}else l=this.metadata.names[t.y],r=t.title;this.config.legend&&(this.spec.legends=getLegend(this.config))}else l=this.metadata.names[t.y],r=t.title;var f={name:"x",type:"ordinal",range:o,domain:t.xScaleDomain};"group"==t.mode&&(f.padding=.2),t.yScaleDomain.constructor!==Array&&(t.yScaleDomain={data:r,field:l});var m={name:"y",type:this.metadata.types[t.y],range:s,domain:t.yScaleDomain};i.push(f),i.push(m);var g=getXYAxes(t,n,"x",c,"y");if(-1!=t.color&&"stack"==t.mode?a.push(getStackBarMark(t,this.metadata)):-1!=t.color&&"group"==t.mode?a.push(getGroupBarMark(t,this.metadata)):a.push(getBarMark(t,this.metadata)),t.range&&(p=getRangeSignals(t,p),a=getRangeMark(t,a)),"left"==t.orientation&&null!=t.text){var y={value:5};if("right"==t.textAlign)var y={scale:"y",field:this.metadata.names[t.y],offset:2};a.push({type:"text",from:{data:"table"},properties:{update:{x:y,dy:{scale:"x",band:!0,mult:.5},y:{scale:"x",field:this.metadata.names[t.x]},align:{value:"left"},text:{field:this.metadata.names[t.text]},fill:{value:t.textColor}}}})}if("single"==t.highlight||"multi"==t.highlight){var v;v="multi"==t.highlight?"!multi":"multi",e.push({name:"selectedPoints",modify:[{type:"clear",test:v},{type:"toggle",signal:"clickedPoint",field:"id"}]}),p.push({name:"clickedPoint",init:0,verbose:!0,streams:[{type:"click",expr:"datum._id"}]},{name:"multi",init:!1,verbose:!0,streams:[{type:"click",expr:"datum._id"}]}),""==t.selectionColor?a[0].properties.update.fillOpacity=[{test:"indata('selectedPoints', datum._id, 'id')",value:1},{value:t.selectionOpacity}]:a[0].properties.update.fill=[{test:"indata('selectedPoints', datum._id, 'id')",value:t.selectionColor},a[0].properties.update.fill]}this.spec.width=t.width,this.spec.height=t.height,this.spec.axes=g,this.spec.data=e,this.spec.scales=i,this.spec.padding=t.padding,this.spec.marks=a,this.spec.signals=p,JSON.stringify(this.spec)};bar.prototype.draw=function(e,t){if(-1!=this.config.maxLength){var a=this.spec.data[0].values,i=this.config.maxLength;if(a.length>=this.config.maxLength){for(var l=[],r=a.length-i,o=r;o<a.length;o++)l.push(a[o]);this.spec.data[0].values=l}}this.config.tooltip.type="rect",drawChart(e,this,t)},bar.prototype.insert=function(e){var t=this.metadata.names[this.config.x],a=this.metadata.names[this.config.y],l=(this.metadata.names[this.config.size],this.metadata.names[this.config.color]);if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+e.length){var r=this.view.data(this.config.title).values().concat(e),o=[];for(i=0;i<r.length-this.config.maxLength;i++)o.push(this.view.data(this.config.title).values()[i][t]);for(i=0;i<e.length;i++){var s=!1;if(this.view.data(this.config.title).update(function(a){return null==l?a[t]==e[i][t]:a[t]==e[i][t]&&a[l]==e[i][l]},a,function(t){return s=!0,e[i][a]}),s){var n=!1,c=o.indexOf(e[i][t]);c>-1&&(n=!0,o.splice(c,1)),n||o.splice(o.length-1,1)}else this.view.data(this.config.title).insert([e[i]]),this.view.update()}var p,d=function(e){return e[t]==p};for(i=0;i<o.length;i++)p=o[i],this.view.data(this.config.title).remove(d)}else for(i=0;i<e.length;i++){var s=!1;this.view.data(this.config.title).update(function(a){return null==l?a[t]==e[i][t]:a[t]==e[i][t]&&a[l]==e[i][l]},a,function(t){return s=!0,e[i][a]}),s||this.view.data(this.config.title).insert([e[i]])}"group"==this.config.mode?this.view.update():this.view.update({duration:200})},bar.prototype.getSpec=function(){return this.spec},bar.prototype.setSpec=function(e){this.spec=e};var vizg=function(e,t){if(e=buildTable(e),"undefined"!=typeof t.charts&&1==t.charts.length){for(var a in t.charts[0])t.charts[0].hasOwnProperty(a)&&(t[a]=t.charts[0][a]);this.chart=new window[t.type]([e],t)}};vizg.prototype.draw=function(e,t){this.chart.draw(e,t)},vizg.prototype.insert=function(e){this.chart.insert(buildData(e,this.chart.metadata))},vizg.prototype.getSpec=function(){return this.chart.getSpec()};var line=function(e,t){this.metadata=e[0].metadata;var a=[],i=[];this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title;var l=getXYScales(t,this.metadata);if("stack"==t.mode){var r={name:"stack",source:t.title,transform:[{type:"aggregate",groupby:[this.metadata.names[t.x]],summarize:[{field:this.metadata.names[t.y],ops:["sum"]}]}]};e.push(r),yColumn="sum_"+this.metadata.names[t.y],yDomain="stack",l[1].domain={data:yDomain,field:yColumn}}if(-1!=t.color){-1==t.colorDomain&&(t.colorDomain={data:t.title,field:this.metadata.names[t.color]});var o={name:"color",type:"ordinal",domain:t.colorDomain,range:t.colorScale};l.push(o);var s="Legend";"table"!=t.title&&(s=t.title),this.config.legend&&(this.spec.legends=getLegend(this.config))}var n=getXYAxes(t,"x","x","y","y");a.push(getLineMark(t,this.metadata)),t.fillOpacity=0,t.markSize=1e3,a.push(getSymbolMark(t,this.metadata)),t.fillOpacity=1,t.markSize=15,a.push(getSymbolMark(t,this.metadata)),t.range&&(i=getRangeSignals(t,i),a=getRangeMark(t,a)),this.spec.width=t.width,this.spec.height=t.height,this.spec.axes=n,this.spec.data=e,this.spec.scales=l,this.spec.padding=t.padding,this.spec.marks=a,this.spec.signals=i};line.prototype.draw=function(e,t){if(-1!=this.config.maxLength){var a=this.spec.data[0].values,i=this.config.maxLength;if(a.length>=this.config.maxLength){for(var l=[],r=a.length-i,o=r;o<a.length;o++)l.push(a[o]);this.spec.data[0].values=l}}drawChart(e,this,t)},line.prototype.insert=function(e){if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+e.length){var t=function(e){return e[this.metadata.names[this.config.x]]==a}.bind(this);for(i=0;i<e.length;i++){var a=this.view.data(this.config.title).values()[i][this.metadata.names[this.config.x]];this.view.data(this.config.title).remove(t)}}this.view.data(this.config.title).insert(e),this.view.update()},line.prototype.getSpec=function(){return this.spec};var map=function(e,t){this.metadata=e[0].metadata;var a,l,r=[],o=[];this.spec={};var s;for(s=loadGeoMapCodes(t.helperUrl),t=checkConfig(t,this.metadata),this.config=t,this.config.geoInfoJson=s,i=0;i<e[0].values.length;i++)for(var n in e[0].values[i])if(n==e[0].metadata.names[t.x]&&e[0].values[i].hasOwnProperty(n)){e[0].values[i].unitName=e[0].values[i][n],e[0].values[i][n]=getMapCode(e[0].values[i][n],t.mapType,s);break}e[0].name=t.title,e[0].transform=[{type:"formula",field:"v",expr:"datum."+this.metadata.names[t.y]}],t.tooltip.enabled&&(a=getMapMark(t,this.metadata),l=getMapSignals(),this.spec.signals=l),e.push(getTopoJson(t,this.metadata)),r.push(getMapPredicates()),t.legend&&o.push(getMapLegends(t,this.metadata));var c={name:"color",type:"linear",domain:{data:"geoData",field:"zipped.v"},domainMin:0,zero:!1,range:t.colorScale},p=[c];this.spec.width=t.width,this.spec.height=t.height,this.spec.data=e,this.spec.scales=p,this.spec.padding=t.padding,this.spec.marks=a,this.spec.predicates=r,this.spec.legends=o};map.prototype.draw=function(e,t){var a=function(a){if(this.view=a({el:e}).renderer(this.config.renderer).update(),null!=t)for(var i=0;i<t.length;i++)this.view.on(t[i].type,t[i].callback)}.bind(this);vg.parse.spec(this.spec,a)},map.prototype.insert=function(e){var t=this.metadata.names[this.config.x],a=this.metadata.names[this.config.y],l=this.metadata.names[this.config.color],r=this.config.mapType,o=this.config.geoInfoJson;for(i=0;i<e.length;i++)for(var s in e[i])if(s==t&&e[i].hasOwnProperty(s)){e[i].unitName=e[i][s],e[i][s]=getMapCode(e[i][s],r,o);break}for(i=0;i<e.length;i++){var n=!1;this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},a,function(t){return n=!0,e[i][a]}),this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},l,function(t){return n=!0,e[i][l]}),n||this.view.data(this.config.title).insert([e[i]])}this.view.update()},map.prototype.getSpec=function(){return this.spec};var number=function(e,t){this.metadata=e[0].metadata,this.data=e[0].values,this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title};number.prototype.draw=function(e){e=e.replace("#","");var t=e+"Content",a="";null!=this.data&&0!=this.data.length&&(a=this.data[this.data.length-1][this.metadata.names[this.config.x]]);var i="<p class='title"+t+"'>"+this.config.title+"</p><p class='val"+t+"' id='val"+t+"'>"+a+"</p><p class='diff"+t+"' id='diff"+t+"'>0</p><p class='diffPercentage"+t+"' id='diffPercentage"+t+"'>0%</p>";document.getElementById(e).innerHTML=i,this.view=t},number.prototype.insert=function(e){
    var t,a=e[e.length-1][this.metadata.names[this.config.x]],i=document.getElementById("val"+this.view).innerHTML,l=a-i,r="";t=""!=i&&0!=i?100*(l/i).toFixed(2)+"%":"",l>0&&(r="+"),document.getElementById("diffPercentage"+this.view).innerHTML=r+t,document.getElementById("diff"+this.view).innerHTML=r+l,document.getElementById("val"+this.view).innerHTML=a};var scatter=function(e,t){this.metadata=e[0].metadata;var a=[];this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title;var i={name:"size",type:"linear",range:[0,576],domain:{data:t.title,field:this.metadata.names[t.size]}},l={name:"color",type:this.metadata.types[t.color],range:t.colorScale,domain:{data:t.title,field:this.metadata.names[t.color]}},r=getXYScales(t,this.metadata);r.push(i),r.push(l);var o=getXYAxes(t,"x","x","y","y");a.push(getScatterMark(t,this.metadata)),this.config.legend&&"linear"!=this.metadata.types[t.color]&&(this.spec.legends=getLegend(this.config)),this.spec.width=t.width,this.spec.height=t.height,this.spec.axes=o,this.spec.data=e,this.spec.scales=r,this.spec.padding=t.padding,this.spec.marks=a};scatter.prototype.draw=function(e,t){var a=function(a){if(this.config.tooltip.enabled?(createTooltip(e),this.view=a({el:e}).renderer(this.config.renderer).update(),bindTooltip(e,this.view,this.config,this.metadata)):this.view=a({el:e}).renderer(this.config.renderer).update(),null!=t)for(var i=0;i<t.length;i++)this.view.on(t[i].type,t[i].callback)}.bind(this);if(-1!=this.config.maxLength){var i=this.spec.data[0].values,l=this.config.maxLength;if(i.length>=this.config.maxLength){for(var r=[],o=i.length-l,s=o;s<i.length;s++)r.push(i[s]);this.spec.data[0].values=r}}vg.parse.spec(this.spec,a)},scatter.prototype.insert=function(e){var t=this.metadata.names[this.config.x],a=this.metadata.names[this.config.y],l=this.metadata.names[this.config.size],r=this.metadata.names[this.config.color];if(-1!=this.config.maxLength&&this.config.maxLength<this.view.data(this.config.title).values().length+e.length){var o=this.view.data(this.config.title).values().concat(e),s=[];for(i=0;i<o.length-this.config.maxLength;i++)s.push(this.view.data(this.config.title).values()[i][t]);for(i=0;i<e.length;i++){var n=!1;if(this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},a,function(t){return n=!0,e[i][a]}),this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},r,function(t){return n=!0,e[i][r]}),this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},l,function(t){return n=!0,e[i][l]}),n){var c=!1,p=s.indexOf(e[i][t]);p>-1&&(c=!0,s.splice(p,1)),c||s.splice(s.length-1,1)}else this.view.data(this.config.title).insert([e[i]]),this.view.update()}var d,h=function(e){return e[t]==d};for(i=0;i<s.length;i++)d=s[i],this.view.data(this.config.title).remove(h)}else for(i=0;i<e.length;i++){var n=!1;this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},a,function(t){return n=!0,e[i][a]}),this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},r,function(t){return n=!0,e[i][r]}),this.view.data(this.config.title).update(function(a){return a[t]==e[i][t]},l,function(t){return n=!0,e[i][l]}),n||this.view.data(this.config.title).insert([e[i]])}this.view.update({duration:200})},scatter.prototype.getSpec=function(){return this.spec};var table=function(e,t){this.metadata=e[0].metadata,this.data=e[0].values,this.spec={},t=checkConfig(t,this.metadata),this.config=t,e[0].name=t.title,null==this.config.columnTitles&&(this.config.columnTitles=this.config.columns)};table.prototype.draw=function(e){var t=d3.select(e).append("table").attr("class","table table-bordered").attr("id",this.config.title);t.append("thead").attr("align","center").append("tr").selectAll("th").data(this.config.columnTitles).enter().append("th").html(function(e){return e}),t.append("tbody").attr("id","tableChart-"+this.config.title),this.setupData(this.data,this.config),t.selectAll("thead th").html(function(e){return e.charAt(0).toUpperCase()+e.substr(1)})},table.prototype.insert=function(e){this.setupData(e,this.config)},table.prototype.setupData=function(e,t){for(var a=[],i=this.metadata.names,l=0;l<e.length;l++){for(var r={},o=0;o<t.columns.length;o++)r[t.columns[o]]=e[l][t.columns[o]];a.push(r)}var s=d3.select("#tableChart-"+t.title).selectAll("tr").data(a,function(e){return e[t.key]}),n=s.enter().append("tr").selectAll("td").data(function(e){return t.columns.map(function(t){return{column:t,value:e[t]}})}).enter().append("td");-1!=t.color&&d3.select("#tableChart-"+t.title).selectAll("td").attr("bgcolor",function(e){var a,l=e.key||e.column;a="string"==typeof t.colorScale?window.d3.scale[t.colorScale]().range():t.colorScale;for(var r,o=0;o<i.length;o+=1)i[o]===l&&(r=o);if("string"==typeof e.value&&("*"==t.color||l==i[t.color])){var s;s=-1==t.colorDomain?[d3.min(d3.select("#tableChart-"+t.title).selectAll("tr").data(),function(e){return e[l]}),d3.max(d3.select("#tableChart-"+t.title).selectAll("tr").data(),function(e){return e[l]})]:t.colorDomain;var a;a="string"==typeof t.colorScale?window.d3.scale[t.colorScale]().range():t.colorScale;var n=d3.scale.ordinal().range(a).domain(s);return n(e.value)}if("*"==t.color||l==i[t.color]){var n=d3.scale.linear().range(["#f2f2f2",a[r]]).domain([d3.min(d3.select("#tableChart-"+t.title).selectAll("tr").data(),function(e){return e[l]}),d3.max(d3.select("#tableChart-"+t.title).selectAll("tr").data(),function(e){return e[l]})]);return n(e.value)}}),n.append("span");var c=s.selectAll("td").style({padding:"0px 10px 0px 10px"}).data(function(e){return d3.map(e).entries()}).attr("class",function(e){return e.key});if(c.select("span").html(function(e){return e.value}),-1!=t.maxLength&&d3.select("tbody").selectAll("tr").data().length>t.maxLength){var p=d3.select("tbody").selectAll("tr").data().slice(d3.select("tbody").selectAll("tr").data().length-t.maxLength,t.maxLength);d3.select("tbody").selectAll("tr").data(p,function(e){return e}).remove()}};var extend=function(e,t){var a,i={};for(a in e)Object.prototype.hasOwnProperty.call(e,a)&&(i[a]=e[a]);for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&(i[a]=t[a]);return i},stack=function(e,t){this.barChart=new bar(e,t),this.metadata=this.barChart.metadata;var a=this.barChart.getSpec();a.axes=[a.axes[0]],a.axes[0].grid=!1,a.data.push({name:"selectedPoints",modify:[{type:"clear",test:"!multi"},{type:"toggle",signal:"clickedPoint",field:"id"}]}),a.signals.push({name:"clickedPoint",init:0,verbose:!0,streams:[{type:"click",expr:"datum._id"}]},{name:"multi",init:!1,verbose:!0,streams:[{type:"click",expr:"datum._id"}]});var i=JSON.parse(JSON.stringify(a.marks[0]));i.type="text",i.properties.update.text={field:a.marks[0].properties.update.fill.field},i.properties.update.x.offset=10,i.properties.update.y.offset=-5,i.properties.update.fill={value:t.legendTitleColor},delete i.properties.update.y2,delete i.properties.hover,a.marks.push(i),delete a.marks[0].properties.hover,a.marks[0].properties.update.fill=[{test:"indata('selectedPoints', datum._id, 'id')",value:t.selectionColor},a.marks[0].properties.update.fill],this.barChart.setSpec(a)};stack.prototype.draw=function(e,t){this.barChart.draw(e,t)},stack.prototype.insert=function(e){this.barChart.insert(e)},stack.prototype.getSpec=function(){return this.barChart.getSpec()};